<form [formGroup]="form">
  <div class="form-row">
    <mat-autocomplete
      #lookupAuto="matAutocomplete"
      [displayWith]="getLookupName"
    >
      @for (i of items$ | async; track i) {
        <mat-option [value]="i" (onSelectionChange)="pickItem(i)"
          >{{ getLookupName(i) }}
        </mat-option>
      }
    </mat-autocomplete>

    <!-- active -->
    @if (lookupActive()) {
      <mat-form-field>
        <input
          matInput
          type="text"
          [placeholder]="label() || 'lookup'"
          [formControl]="lookup"
          [matAutocomplete]="lookupAuto"
          cadmusAutoFocus
        />
        <button
          type="button"
          mat-icon-button
          matSuffix
          (click)="clear()"
          [disabled]="!item()"
          matTooltip="Clear"
        >
          <mat-icon class="mat-warn">clear</mat-icon>
        </button>
      </mat-form-field>
      <!-- progress spinner -->
      @if (loading()) {
        <div>
          <mat-spinner
            mode="indeterminate"
            diameter="24"
            strokeWidth="3"
          ></mat-spinner>
        </div>
      }
    }

    <!-- inactive -->
    @else {
      <div class="flex-row">
        <div class="labeled">
          @if (label()) {
            <div class="label">
              {{ label() }}
              @if (required() && (invalid$ | async)) {
                <span class="required">&nbsp;required</span>
              }
            </div>
          }
          <button
            type="button"
            mat-flat-button
            (click)="lookupActive.set(true)"
          >
            {{ getLookupName(item()) || label() }}
          </button>
        </div>
        <!-- scope selector (only when multiple scopes available) -->
        @if (availableScopes().length > 1) {
          <mat-form-field class="scope-selector">
            <mat-label>scope</mat-label>
            <mat-select
              [value]="selectedScopeKey()"
              (selectionChange)="onScopeChange($event.value)"
            >
              @for (scope of availableScopes(); track scope.key) {
                <mat-option [value]="scope.key">{{ scope.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        }
        <!-- buttons -->
        @if (linkTemplate()) {
          <button
            type="button"
            mat-icon-button
            (click)="openLink()"
            [disabled]="!item()"
            matTooltip="Open the web resource"
          >
            <mat-icon>link</mat-icon>
          </button>
        }
        @if (optDialog()) {
          <button
            type="button"
            mat-icon-button
            (click)="showOptions()"
            matTooltip="Change quick options"
          >
            <mat-icon>settings</mat-icon>
          </button>
        }
        @if (hasMore()) {
          <button
            type="button"
            mat-icon-button
            (click)="requestMore()"
            matTooltip="Search with more details"
          >
            <mat-icon class="mat-primary">more</mat-icon>
          </button>
        }
      </div>
    }
  </div>
</form>
